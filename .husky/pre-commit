# Run lint-staged first
pnpm lint-staged

# Check for dependency mismatches
echo ""
echo "üîç Checking for dependency version mismatches..."
pnpm deps:mismatch

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Dependency version mismatches found!"
  echo "Run 'pnpm deps:fix' to fix them, then try committing again."
  exit 1
fi

echo "‚úÖ No dependency mismatches"

# Check if UI package files are staged
UI_FILES_STAGED=$(git diff --cached --name-only | grep "^packages/ui/src" || true)

if [ -n "$UI_FILES_STAGED" ]; then
  echo ""
  echo "üì¶ UI package changes detected, running additional checks..."

  # Verify bundle exclusions
  echo ""
  echo "üîç Verifying bundle exclusions..."
  if ! pnpm verify:bundle; then
    echo ""
    echo "‚ùå Bundle verification failed!"
    echo "Test files may be included in production bundle."
    exit 1
  fi

  # Run performance tests (only if component files changed)
  COMPONENT_FILES_STAGED=$(echo "$UI_FILES_STAGED" | grep "packages/ui/src/components" || true)
  if [ -n "$COMPONENT_FILES_STAGED" ]; then
    echo ""
    echo "‚ö° Running performance tests..."
    if ! pnpm --filter @kartuli/ui test:perf; then
      echo ""
      echo "‚ùå Performance tests failed!"
      echo "Review performance regressions before committing."
      echo ""
      echo "üí° To skip this check, use: git commit --no-verify"
      exit 1
    fi
    echo "‚úÖ Performance tests passed"
  fi
fi

echo ""
echo "‚ú® All pre-commit checks passed!"
